# Generated by salt
*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
COMMIT
*nat
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
{#- make sure all jinja tags have the - at the beginning to remove whitespace b/c iptables-restore will throw an error on blank lines #}
{%- set roles = grains.get('roles', []) %}
{%- if 'lxc_host' in roles %}
{%- set port_forwards = pillar.get('lxc_hosts', {}).get(grains['fqdn'], {}).get('port_forwards', []) %}
{%- if port_forwards %}
{%- for dnat in port_forwards %}
{%- set source = dnat.get('source', None) %}
-A PREROUTING -i {{dnat.get('interface', 'eth0')}}{% if source %} --source {{source}}{% endif %} -p {{dnat['protocol']|default('tcp')}} -m {{dnat['protocol']|default('tcp')}} --dport {{dnat['port']}} -j DNAT --to-destination {{dnat['destination']}}
{%- endfor %}
{%- endif %}{#- end port forwards #}
{#- default subnet, may want to parameterize later #}
-A POSTROUTING -s 10.0.3.0/24 ! -d 10.0.3.0/24 -j MASQUERADE
{%- endif %}{#- end lxc_host #}
COMMIT
# vim: set filetype=iptables :
